/*
 * GPII Untrusted Flow Manager Test Infrastructure
 *
 * Copyright 2015 OCAD University
 *
 * Licensed under the New BSD license. You may not use this file except in
 * compliance with this License.
 *
 * The research leading to these results has received funding from the European Union's
 * Seventh Framework Programme (FP7/2007-2013)
 * under grant agreement no. 289016.
 *
 * You may obtain a copy of the License at
 * https://github.com/GPII/universal/blob/master/LICENSE.txt
 */

"use strict";

var fluid = require("infusion"),
    fs = require("fs"),
    gpii = fluid.registerNamespace("gpii"),
    kettle = fluid.registerNamespace("kettle");

fluid.registerNamespace("gpii.test.untrustedFlowManager.combinedConfig");

gpii.test.untrustedFlowManager.combinedConfig.template = {
    type: "fluid.eventedComponent",
    options: {
        gradeNames: "autoInit",
        components: {
            server: {
                type: "fluid.eventedComponent",
                options: {
                    gradeNames: "autoInit",
                    components: {
                        localConfig: {
                            type: "fluid.eventedComponent",
                            // To be filled in
                            options: null
                        },
                        cloudBasedConfig: {
                            type: "fluid.eventedComponent",
                            // To be filled in
                            options: null
                        }
                    },
                    events: {
                        onListen: {
                            events: {
                                onListenLocal: "{localConfig}.server.events.onListen",
                                onListenCloud : "{cloudBasedConfig}.server.events.onListen"
                            }
                        },
                        onStopped: {
                            events: {
                                onStoppedLocal: "{localConfig}.server.events.onStopped",
                                onStoppedCloud : "{cloudBasedConfig}.server.events.onStopped"
                            }
                        }
                    },
                    invokers: {
                        stop: {
                            funcName: "gpii.test.untrustedFlowManager.stopServers",
                            args: [ ["{localConfig}.server", "{cloudBasedConfig}.server"] ]
                        }
                    }
                }
            }
        }
    }
};

gpii.test.untrustedFlowManager.combinedConfig.build = function (untrustedFlowManagerConfigName,
                                                                untrustedFlowManagerConfigPath,
                                                                cloudBasedFlowManagerConfigName,
                                                                cloudBasedFlowManagerConfigPath) {

    var untrustedFlowManagerConfig = fluid.copy(fluid.defaults(kettle.config.createDefaults({
        configName: untrustedFlowManagerConfigName,
        configPath: untrustedFlowManagerConfigPath
    })));

    var cloudBasedFlowManagerConfig = fluid.copy(fluid.defaults(kettle.config.createDefaults({
        configName: cloudBasedFlowManagerConfigName,
        configPath: cloudBasedFlowManagerConfigPath
    })));

    delete untrustedFlowManagerConfig.gradeNames;
    delete cloudBasedFlowManagerConfig.gradeNames;

    var config = fluid.copy(gpii.test.untrustedFlowManager.combinedConfig.template);

    fluid.set(config, "options.components.server.options.components.localConfig.options",
              untrustedFlowManagerConfig);
    fluid.set(config, "options.components.server.options.components.cloudBasedConfig.options",
              cloudBasedFlowManagerConfig);

    return config;
};

gpii.test.untrustedFlowManager.stopServers = function (servers) {
    fluid.each(servers, function (server) {
        server.stop();
    });
};

gpii.test.untrustedFlowManager.makeFileRemover = function (filename) {
    return function () {
        fs.unlinkSync(filename);
    };
};
