/**
 * GPII Capture Tests
 *
 * Copyright 2019 Raising the Floor - International
 *
 * Licensed under the New BSD license. You may not use this file except in
 * compliance with this License.
 *
 * You may obtain a copy of the License at
 * https://github.com/GPII/universal/blob/master/LICENSE.txt
 */

"use strict";

var fluid = require("infusion"),
    gpii = fluid.registerNamespace("gpii"),
    kettle = require("kettle");

var jqUnit = require("node-jqunit");

fluid.require("%gpii-universal");
gpii.loadTestingSupport();

fluid.registerNamespace("gpii.tests.flowManager.capture");

kettle.config.createDefaults({
    configName: "gpii.flowManager.tests.capture.fakeData.config",
    configPath: "%gpii-universal/gpii/node_modules/flowManager/test/configs"
});

fluid.defaults("gpii.tests.flowManager.capture.tests", {
    gradeNames: ["fluid.test.testEnvironment", "fluid.test.testCaseHolder"],
    modules: [
        {
            name: "Simple system capture",
            tests: [{
                name: "Check for existing FakeMag Settings",
                expect: 2,
                sequence: [{
                    funcName: "gpii.tests.flowManager.capture.adjustSolutions",
                    args: ["{config}.server.flowManager.solutionsRegistryDataSource"]
                }, {
                    task: "{config}.server.flowManager.capture.getSystemSettingsCapture",
                    args: [],
                    resolve: "gpii.tests.flowManager.capture.checkForFakeMags",
                    resolveArgs: ["{arguments}.0"]
                }]
            }]
        }
    ],
    components: {
        "config": {
            type: "gpii.flowManager.tests.capture.fakeData.config"
        }
    }
});

gpii.tests.flowManager.capture.checkForFakeMags = function (payload) {

    jqUnit.assertDeepEq("FakeMag1 with multiple settings handlers", payload.fakemag1, {
        "magnification": 2,
        "invert": true
    });

    jqUnit.assertDeepEq("FakeMag2 with single settings handler", payload.fakemag2, {
        "magnification": 2,
        "invert": true
    });

};

gpii.tests.flowManager.capture.adjustSolutions = function (solutionsRegistryDataSource) {
    var testDataFile = __dirname + "/data/capture_fakemag_settings.json";

    solutionsRegistryDataSource.fullSolutionsRegistry.darwin.fakemag2.settingsHandlers.configuration.options.filename = testDataFile;
    solutionsRegistryDataSource.fullSolutionsRegistry.darwin.fakemag1.settingsHandlers.configuration.options.filename = testDataFile;
    solutionsRegistryDataSource.fullSolutionsRegistry.darwin.fakemag1.settingsHandlers.configuration1.options.filename = testDataFile;
};

fluid.test.runTests([
    "gpii.tests.flowManager.capture.tests"
]);
