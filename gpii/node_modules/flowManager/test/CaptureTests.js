/**
 * GPII Untrusted Settings Data Source Tests
 *
 * Copyright 2019 Raising the Floor - International
 *
 * Licensed under the New BSD license. You may not use this file except in
 * compliance with this License.
 *
 * You may obtain a copy of the License at
 * https://github.com/GPII/universal/blob/master/LICENSE.txt
 */

"use strict";

var fluid = require("infusion"),
    gpii = fluid.registerNamespace("gpii"),
    kettle = require("kettle");

var jqUnit = require("node-jqunit");

fluid.require("%gpii-universal");
gpii.loadTestingSupport();

fluid.registerNamespace("gpii.tests.flowManager.capture");

kettle.config.createDefaults({
    configName: "gpii.flowManager.tests.capture.fakeData.config",
    configPath: "%gpii-universal/gpii/node_modules/flowManager/test/configs"
});

fluid.defaults("gpii.tests.flowManager.capture.tests", {
    gradeNames: ["fluid.test.testEnvironment", "fluid.test.testCaseHolder"],
    modules: [
        {
            name: "Simple system capture",
            tests: [{
                name: "Check for existing FakeMag2 Settings",
                expect: 1,
                sequence: [{
                    funcName: "gpii.tests.flowManager.capture.adjustSolutions",
                    args: ["{config}.server.flowManager.solutionsRegistryDataSource"]
                }, {
                    task: "{config}.server.flowManager.capture.getSystemSettingsCapture",
                    args: [],
                    resolve: "gpii.tests.flowManager.capture.checkForFakeMag2",
                    resolveArgs: ["{arguments}.0"]
                }]
            }]
        }
    ],
    components: {
        "config": {
            type: "gpii.flowManager.tests.capture.fakeData.config"
        }
    }
});

gpii.tests.flowManager.capture.checkForFakeMag2 = function (payload) {
    // TODO add tests for solutions with multiple capabilities blocks. At the moment I believe they are all
    // going to end up in separate blocks.
    fluid.each(payload, function (item) {
        if (item.fakemag2) {
            jqUnit.assertDeepEq("FakeMag2", {
                "fakemag2": [
                    {
                        "settings": {
                            "magnification": 2,
                            "invert": true
                        }
                    }
                ]
            }, item);
        }
    });
};

gpii.tests.flowManager.capture.adjustSolutions = function (solutionsRegistryDataSource) {
    var testDataFile = __dirname + "/data/capture_fakemag2_settings.json";
    solutionsRegistryDataSource.fullSolutionsRegistry.darwin.fakemag2.settingsHandlers.configuration.options.filename = testDataFile;
};

fluid.test.runTests([
    "gpii.tests.flowManager.capture.tests"
]);
