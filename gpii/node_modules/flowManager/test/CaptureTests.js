/**
 * GPII Capture Tests
 *
 * Copyright 2019 Raising the Floor - International
 *
 * Licensed under the New BSD license. You may not use this file except in
 * compliance with this License.
 *
 * You may obtain a copy of the License at
 * https://github.com/GPII/universal/blob/master/LICENSE.txt
 */

"use strict";

var fluid = require("infusion"),
    gpii = fluid.registerNamespace("gpii"),
    kettle = require("kettle");

var jqUnit = require("node-jqunit");

fluid.require("%gpii-universal");
gpii.loadTestingSupport();

fluid.registerNamespace("gpii.tests.flowManager.capture");

kettle.config.createDefaults({
    configName: "gpii.flowManager.tests.capture.fakeData.config",
    configPath: "%gpii-universal/gpii/node_modules/flowManager/test/configs"
});

gpii.tests.flowManager.capture.checkForFakeMags = function (payload) {
    jqUnit.assertDeepEq("FakeMag1 with multiple settings handlers", payload.fakemag1, {
        "magnification": 2,
        "invert": true
    });

    jqUnit.assertDeepEq("FakeMag2 with single settings handler", payload.fakemag2, {
        "magnification": 2,
        "invert": true
    });
};

gpii.tests.flowManager.capture.platformReporter = function () {
    return {
        id: "darwin"
    };
};

gpii.tests.flowManager.capture.checkForInstalledMags = function (payload) {
    jqUnit.assertEquals("There should be 2 solutions installed", 2, Object.keys(payload).length);
    jqUnit.assertEquals("Check for Fake Mag 1", payload.fakemag1.name, "Fake Magnifier 1");
    jqUnit.assertEquals("Check for Fake Mag 2", payload.fakemag2.name, "Fake Magnifier 2 - fully featured");
};

gpii.tests.flowManager.capture.adjustSolutions = function (solutionsRegistryDataSource) {
    var testDataFile = __dirname + "/data/capture_fakemag_settings.json";

    // The solutions block is a read only data structure
    var adjustedSolutions = fluid.copy(solutionsRegistryDataSource.fullSolutionsRegistry);
    adjustedSolutions.darwin.fakemag2.settingsHandlers.configuration.options.filename = testDataFile;
    adjustedSolutions.darwin.fakemag1.settingsHandlers.configuration.options.filename = testDataFile;
    adjustedSolutions.darwin.fakemag1.settingsHandlers.configuration1.options.filename = testDataFile;
    solutionsRegistryDataSource.fullSolutionsRegistry = adjustedSolutions;
};

fluid.defaults("gpii.tests.flowManager.capture.tests", {
    gradeNames: ["fluid.test.testEnvironment", "fluid.test.testCaseHolder"],
    modules: [
        {
            name: "Simple system capture",
            tests: [{
                name: "Check for existing FakeMag Settings",
                expect: 2,
                sequence: [{
                    funcName: "gpii.tests.flowManager.capture.adjustSolutions",
                    args: ["{config}.server.flowManager.solutionsRegistryDataSource"]
                }, {
                    task: "{config}.server.flowManager.capture.getSystemSettingsCapture",
                    args: [],
                    resolve: "gpii.tests.flowManager.capture.checkForFakeMags",
                    resolveArgs: ["{arguments}.0"]
                }]
            }]
        },
        {
            name: "Simple installed solutions fetch",
            tests: [{
                name: "Testing get installed solutions",
                expect: 3,
                sequence: [{
                    funcName: "gpii.tests.flowManager.capture.adjustSolutions",
                    args: ["{config}.server.flowManager.solutionsRegistryDataSource"]
                }, {
                    task: "{config}.server.flowManager.capture.getInstalledSolutionsForCurrentDevice",
                    args: [],
                    resolve: "gpii.tests.flowManager.capture.checkForInstalledMags",
                    resolveArgs: ["{arguments}.0"]
                }]
            }]
        }
    ],
    components: {
        "config": {
            type: "gpii.flowManager.tests.capture.fakeData.config"
        }
    }
});

fluid.test.runTests([
    "gpii.tests.flowManager.capture.tests"
]);

/*
 *  Tests for formatting raw captures.
 */
gpii.tests.flowManager.capture.testFormatRawCapturedSettings = function () {
    var allCorrectSettings = gpii.flowManager.capture.formatRawCapturedSettings([
        {
            "fakemag1": [
                {
                    "settings": {
                        "magnification": 2
                    }
                }
            ]
        },
        {
            "fakemag1": [
                {
                    "settings": {
                        "invert": true
                    }
                }
            ]
        },
        {
            "fakemag2": [
                {
                    "settings": {
                        "magnification": 2,
                        "invert": true
                    }
                }
            ]
        }
    ]);
    jqUnit.assertDeepEq("There should be 2 solutions each with 2 settings from the all correct payload",
        allCorrectSettings, {
            "fakemag1": {
                "magnification": 2,
                "invert": true
            },
            "fakemag2": {
                "magnification": 2,
                "invert": true
            }
        });

    var someErrorsSettings = gpii.flowManager.capture.formatRawCapturedSettings([
        {
            "fakemag1": [
                {
                    "settings": {
                        "magnification": 2
                    }
                }
            ]
        },
        {
            "fakemag1": [
                {
                    "settings": {
                        "invert": true
                    }
                }
            ]
        },
        {
            isError: true,
            msg: "This didn't work properly during capture"
        },
        {
            "fakemag2": [
                {
                    "settings": {
                        "magnification": 2,
                        "invert": true
                    }
                }
            ]
        }
    ]);
    jqUnit.assertDeepEq("There should still be 2 solutions each with 2 settings from the all payload that contained an error in addition to correct entries.",
    someErrorsSettings, {
        "fakemag1": {
            "magnification": 2,
            "invert": true
        },
        "fakemag2": {
            "magnification": 2,
            "invert": true
        }
    });
};

jqUnit.test("Test Raw Settings Formatting", gpii.tests.flowManager.capture.testFormatRawCapturedSettings);
