/**
 * GPII Flow Manager Privacy Filtering
 *
 * Copyright 2013 OCAD University
 *
 * Licensed under the New BSD license. You may not use this file except in
 * compliance with this License.
 *
 * The research leading to these results has received funding from the European Union's
 * Seventh Framework Programme (FP7/2007-2013)
 * under grant agreement no. 289016.
 *
 * You may obtain a copy of the License at
 * https://github.com/GPII/universal/blob/master/LICENSE.txt
 */

"use strict";

var fluid = fluid || require("infusion");
var $ = fluid.registerNamespace("jQuery");
var gpii = fluid.registerNamespace("gpii");

fluid.defaults("gpii.flowManager.privacy.privacyFilter", {
    gradeNames: ["fluid.littleComponent", "autoInit"],
    members: {
        forwardTransform: null, // Supplied by client
        reverseTransform: null  // Supplied by client
    },
    invokers: {
        filter: {
            funcName: "gpii.flowManager.privacy.filter",
            args: [
                "{arguments}.0", // payload
                "{arguments}.1", // selectedPreferencesMap
                "{that}.forwardTransform",
                "{that}.reverseTransform"
            ]
        }
    }
});

gpii.flowManager.privacy.applyFilterRules = function (settings, rules) {
    var holder = {
        model: {}
    };
    var applier = fluid.makeNewChangeApplier(holder);
    fluid.each(rules, function (value, path) {
        if (value) {
            var fetched = fluid.get(settings, path);
            applier.change(path, fetched); // TODO: Apparently fluid.set is not good enough to deal with change at root
        }
    });
    return holder.model;
};

gpii.flowManager.privacy.filterOneApplication = function (application, selectedPreferences, forwardTransform, reverseTransform) {
    var settings = application.settings;
    var settingsInPrivacy = fluid.model.transformWithRules(settings, forwardTransform);
    fluid.log("GOT SETTINGS IN PRIVACY ONTOLOGY " + JSON.stringify(settingsInPrivacy, null, 2));
    var filteredSettings = gpii.flowManager.privacy.applyFilterRules(settingsInPrivacy, selectedPreferences);
    fluid.log("GOT FILTERED SETTINGS " + JSON.stringify(filteredSettings, null, 2));
    var backSettings = fluid.model.transformWithRules(filteredSettings, reverseTransform);
    var filteredApplication = fluid.copy(fluid.censorKeys(application, ["settings"]));
    filteredApplication.settings = backSettings;
    fluid.log("RETURNING FILTERED APPLICATION " + JSON.stringify(filteredApplication, null, 2));
    return filteredApplication;
};

// TODO ensure that gpii.flowManager.privacy.filter is
// usable by both the OAuth2 protected endpoint and the endpoint used
// by the untrusted Flow Manager

// TODO question: can matchMakerOutput have any children other than inferredConfiguration?

gpii.flowManager.privacy.filter = function (payload, selectedPreferencesMap, forwardTransform, reverseTransform) {
    fluid.log("|||||| PRIVACY FILTER executing with payload " + JSON.stringify(payload, null, 2) + "\n and selectedPreferencesMap " + JSON.stringify(selectedPreferencesMap, null, 2));

    // TODO: create helpful "copy-on-write" suite of utilities to help with all of this standard manipulation involving "megapayloadism"

    var filteredMatchMakerOutput = { inferredConfiguration: {} };

    var configurations = payload.matchMakerOutput.inferredConfiguration;
    fluid.each(configurations, function (config, configName) {
        fluid.log("|||||| PRIVACY FILTER configName: " + configName);
        var filteredApplications = fluid.transform(config.applications, function (application, solutionId) {
            var selectedPreferences = selectedPreferencesMap[solutionId];
            return gpii.flowManager.privacy.filterOneApplication(application, selectedPreferences, forwardTransform, reverseTransform);
        });
        var filteredConfig = { applications: filteredApplications };
        filteredMatchMakerOutput.inferredConfiguration[configName] = filteredConfig;
    });

    var filteredPayload = $.extend({}, payload);
    filteredPayload.matchMakerOutput = filteredMatchMakerOutput;
    return filteredPayload;
};
