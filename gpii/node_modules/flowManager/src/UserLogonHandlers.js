/*
 * GPII User Logon State Change
 *
 * Copyright 2012 OCAD University
 * Copyright 2015, 2017 Raising the Floor - International
 * Copyright 2018 OCAD University
 *
 * Licensed under the New BSD license. You may not use this file except in
 * compliance with this License.
 *
 * The research leading to these results has received funding from the European Union's
 * Seventh Framework Programme (FP7/2007-2013)
 * under grant agreement no. 289016.
 *
 * You may obtain a copy of the License at
 * https://github.com/GPII/universal/blob/master/LICENSE.txt
 */

"use strict";

var fluid = require("infusion");
var gpii = fluid.registerNamespace("gpii");

// The base handler component containing common functions required by all http request handlers for these endpoints:
// * /user/:gpiiKey/proximityTriggered
// * /user/:gpiiKey/login
// * /user/:gpiiKey/logout
fluid.defaults("gpii.flowManager.baseHandler", {
    gradeNames: ["fluid.component"],
    logonState: "proximityTriggered",
    invokers: {
        handleRequest: {
            funcName: "gpii.flowManager.baseHandler.handleRequest",
            args: ["{flowManager}.lifecycleManager", "{request}", "{that}.options.logonState", "{request}.req.params.gpiiKey"]
                                // logonFunc
        }
    }
});
gpii.flowManager.baseHandler.handleRequest = function (lifecycleManager, request, logonState, gpiiKey) {
    var logonFunc;

    if (logonState === "login") {
        logonFunc = lifecycleManager.performLogin;
    }
    if (logonState === "logout") {
        logonFunc = lifecycleManager.performLogout;
    }
    if (logonState === "proximityTriggered") {
        logonFunc = lifecycleManager.performProximityTriggered;
    }
    var logonPromise = logonFunc(gpiiKey);
    logonPromise.then(request.events.onSuccess.fire, request.events.onError.fire);
};

// Request handler for /user/:gpiiKey/proximityTriggered
fluid.defaults("gpii.flowManager.proximityTrigger.handler", {
    gradeNames: ["kettle.request.http", "gpii.flowManager.baseHandler"],
    logonState: "proximityTriggered"
});

// Request handler for /user/<myGpiiKey>/login
fluid.defaults("gpii.flowManager.userLogin.handler", {
    gradeNames: ["kettle.request.http", "gpii.flowManager.baseHandler"],
    logonState: "login"
});

// Request handler for /user/<myGpiiKey>/logout
fluid.defaults("gpii.flowManager.userLogout.handler", {
    gradeNames: ["kettle.request.http", "gpii.flowManager.baseHandler"],
    logonState: "logout"
});
