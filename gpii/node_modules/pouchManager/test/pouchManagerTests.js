/**
GPII Pouch Manager Tests

Copyright 2016 OCAD University

Licensed under the New BSD license. You may not use this file except in
compliance with this License.

You may obtain a copy of the License at
https://github.com/GPII/universal/blob/master/LICENSE.txt
*/

"use strict";

var fluid = require("infusion"),
    jqUnit = fluid.require("node-jqunit", require, "jqUnit"),
    kettle = require("kettle"),
    gpii = fluid.registerNamespace("gpii");

require("gpii-pouchdb");
gpii.pouch.loadTestingSupport();

require("pouchManager");
require("journal");

fluid.logObjectRenderChars = 10240;

fluid.registerNamespace("gpii.tests.pouchManager");

gpii.tests.pouchManager.authDBServerPort = 1234;
gpii.tests.pouchManager.resetServerPort = 1244;

//*********** Pouch Manager with Test Specific Configs ***********//
fluid.defaults("gpii.tests.pouchManager", {
    gradeNames: ["gpii.pouchManager"],
    authDBServerPort: gpii.tests.pouchManager.authDBServerPort,
    resetServerPort: gpii.tests.pouchManager.resetServerPort,
    pouchConfig: {
        databases: {
            auth: {
                data: [
                    "%universal/gpii/node_modules/pouchManager/test/data/oauth2TestData.json"
                ]
            }
        }
    }
});

//*********** Test Case Holder ***********//
fluid.defaults("gpii.tests.pouchManager.caseHolder", {
    gradeNames: ["gpii.test.express.caseHolder"],
    sequenceEnd: [{
        func: "{testEnvironment}.events.onCleanup.fire"
    },
    {
        event:    "{testEnvironment}.events.onCleanupComplete",
        listener: "fluid.log",
        args:     ["Database cleanup complete"]
    }],
    expected: {
        total: {
            doc_count: 16
        },
        totalAfterInsert: {
            doc_count: 17
        },
        insert: {
            id: "toinsert",
            foo: "bar"
        }
    },
    rawModules: [{
        name: "Testing Pouch Manager",
        tests: [{
            name: "Testing the load and the reset processes",
            type: "test",
            sequence: [{
                func: "{totalRequest}.send"
            }, {
                listener: "gpii.test.pouch.checkResponse",
                event:    "{totalRequest}.events.onComplete",
                args:     ["{totalRequest}.nativeResponse", "{arguments}.0", 200, "{testCaseHolder}.options.expected.total"]
            }, {
                func: "{insertRequest}.send",
                args: "{that}.options.expected.insert"
            }, {
                listener: "gpii.test.pouch.checkResponse",
                event:    "{insertRequest}.events.onComplete",
                args:     ["{insertRequest}.nativeResponse", "{arguments}.0", 201]
            }, {
                func: "{verifyInsertRequest}.send"
            }, {
                listener: "gpii.test.pouch.checkResponse",
                event:    "{verifyInsertRequest}.events.onComplete",
                args:     ["{verifyInsertRequest}.nativeResponse", "{arguments}.0", 200, "{testCaseHolder}.options.expected.totalAfterInsert"]
            }, {
                func: "{resetRequest}.send"
            }, {
                listener: "jqUnit.assert",
                event:    "{testEnvironment}.events.onPouchHarnessReady",
                args:     ["pouchHarness has been recreated"]
            }, {
                func: "{verifyResetRequest}.send"
            }, {
                listener: "gpii.test.pouch.checkResponse",
                event:    "{verifyResetRequest}.events.onComplete",
                args:     ["{verifyResetRequest}.nativeResponse", "{arguments}.0", 200, "{testCaseHolder}.options.expected.total"]
            }]
        }]
    }],
    components: {
        totalRequest: {
            type: "kettle.test.request.http",
            options: {
                path: "/auth",
                port: gpii.tests.pouchManager.authDBServerPort,
                method: "GET"
            }
        },
        insertRequest: {
            type: "kettle.test.request.http",
            options: {
                path:   "/auth/toinsert",
                port: gpii.tests.pouchManager.authDBServerPort,
                method: "PUT"
            }
        },
        verifyInsertRequest: {
            type: "kettle.test.request.http",
            options: {
                path: "/auth",
                port: gpii.tests.pouchManager.authDBServerPort,
                method: "GET"
            }
        },
        resetRequest: {
            type: "kettle.test.request.http",
            options: {
                path: "/reset-pouch",
                port: gpii.tests.pouchManager.resetServerPort,
                method: "GET"
            }
        },
        verifyResetRequest: {
            type: "kettle.test.request.http",
            options: {
                path: "/auth",
                port: gpii.tests.pouchManager.authDBServerPort,
                method: "GET"
            }
        }
    }
});

gpii.tests.pouchManager.cleanup = function (that) {
    that.pouchManager.pouchHarness.express.expressPouch.events.onCleanup.fire();
};

//*********** Test Environment ***********//
fluid.defaults("gpii.tests.pouchManager.testEnvironment", {
    gradeNames: ["fluid.test.testEnvironment"],
    events: {
        constructFixtures: null,
        onPouchManagerReady: null,
        onPouchHarnessReady: null,
        onFixturesConstructed: {
            events: {
                onPouchManagerReady: "onPouchManagerReady"
            }
        },
        onCleanup: null,
        onCleanupComplete: null
    },
    listeners: {
        "onCleanup.cleanup": {
            funcName: "gpii.tests.pouchManager.cleanup",
            args: ["{that}"]
        }
    },
    components: {
        pouchManager: {
            type: "gpii.tests.pouchManager",
            options: {
                baseDir: {
                    expander: {
                        funcName: "fluid.stringTemplate",
                        args: ["%base/pouchManagerTests", {
                            base: "@expand:{settingsDir}.getSettingsDir()"
                        }]
                    }
                },
                listeners: {
                    "onReady.escalate": "{testEnvironment}.events.onPouchManagerReady.fire",
                    "onPouchHarnessReady.escalate": "{testEnvironment}.events.onPouchHarnessReady.fire"
                },
                distributeOptions: {
                    cleanupListeners: {
                        record: {
                            "onCleanupComplete.escalate": {
                                listener: "{testEnvironment}.events.onCleanupComplete.fire",
                                priority: "before:destroyPouchHarness"
                            }
                        },
                        target: "{that expressPouch}.options.listeners"
                    }
                }
            }
        }
    }
});

//*********** Combine Test Environment and Test Case Holder ***********//
fluid.defaults("gpii.tests.pouchManagerTests", {
    gradeNames: ["gpii.tests.pouchManager.testEnvironment"],
    components: {
        testCaseHolder: {
            type: "gpii.tests.pouchManager.caseHolder"
        }
    }
});

fluid.test.runTests("gpii.tests.pouchManagerTests");
