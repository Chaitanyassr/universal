/*!
GPII Pouch Manager

Copyright 2016 OCAD University

Licensed under the New BSD license. You may not use this file except in
compliance with this License.

You may obtain a copy of the License at
https://github.com/GPII/universal/blob/master/LICENSE.txt
*/

"use strict";

var fluid = require("infusion"),
    gpii = fluid.registerNamespace("gpii");

/*
 * Manage the pouchDB that is used as the auth server data storage when GPII runs in the development mode.
 * Accept these options:
 * @authDBServerPort {Integer} The port number that the pouch express server runs upon.
 * @resetServerPort {Integer} The port number that a express server runs upon for resetting the pouch express server runs at the port of @authDBServerPort
 *  to its initial state. Note that a separate server is needed for the reset is because the underlying library "expressPouchdb" used by gpii.pouch.express
 *  implementation is aggressive enough to respond to any http request rooted at the root.
 * @pouchConfig {Object} Configuration options to config the pouchDB. Refer to https://github.com/GPII/gpii-pouchdb/blob/master/docs/pouch-component.md on details of accepted options.
 */
fluid.defaults("gpii.pouchManager", {
    gradeNames: ["fluid.component"],
    authDBServerPort: 8058,
    resetServerPort: 8059,
    components: {
        settingsDir: {
            type: "gpii.settingsDir"
        },
        pouchHarness: {
            type: "gpii.pouch.harness.persistent",
            options: {
                port: "{pouchManager}.options.authDBServerPort",
                baseDir: "@expand:{settingsDir}.getSettingsDir()",
                listeners: {
                    "onReady.escalate": "{pouchManager}.events.onPouchHarnessReady"
                },
                components: {
                    express: {
                        options: {
                            events: {
                                onCreateExpressPouch: null
                            },
                            listeners: {
                                "onCreate.createExpressPouch": "{that}.events.onCreateExpressPouch.fire"
                            },
                            distributeOptions: [{
                                record: "onCreateExpressPouch",
                                target: "{that > expressPouch}.createOnEvent"
                            }, {
                                record: {
                                    "onCreate.debug": {
                                        funcName: "console.log",
                                        args: ["==== recreated expressPouch"]
                                    },
                                    "onCleanupComplete.recreateExpressPouch": {
                                        listener: "gpii.pouchManager.recreateExpressPouch",
                                        args: ["{gpii.express}"]
                                        // listener: "{gpii.express}.events.onCreateExpressPouch.fire"
                                    },
                                    "onCleanupComplete.debug": {
                                        funcName: "console.log",
                                        args: ["==== listener for onCleanupComplete fired"]
                                    }
                                },
                                target: "{that > expressPouch}.options.listeners"
                            }]
                        }
                    }
                }
            }
        },
        expressReset: {
            type: "gpii.express",
            options: {
                port: "{pouchManager}.options.resetServerPort",
                components: {
                    resetMiddleware: {
                        type: "gpii.pouchManager.resetMiddleware",
                        options: {
                            listeners: {
                                onReset: [{
                                    listener: "{pouchHarness}.express.expressPouch.cleanup",
                                    namespace: "cleanup"
                                }, {
                                    listener: "console.log",
                                    args: ["===== after cleanup, before createExpressPouch"],
                                    namespace: "debug1",
                                    priority: "after:cleanup"
                                // }, {
                                //     listener: "{pouchHarness}.express.events.onCreateExpressPouch.fire",
                                //     namespace: "reInit",
                                //     priority: "after:debug1"
                                // }, {
                                //     listener: "console.log",
                                //     args: ["===== after createExpressPouch"],
                                //     namespace: "debug2",
                                //     priority: "after:reInit"
                                }]
                            }
                        }
                    }
                },
                listeners: {
                    "onStarted.escalate": "{pouchManager}.events.onExpressResetStarted.fire"
                }
            }
        }
    },
    events: {
        onPouchHarnessReady: null,
        onExpressResetStarted: null,
        onReady: {
            events: {
                onPouchHarnessReady: "onPouchHarnessReady",
                onExpressResetStarted: "onExpressResetStarted"
            }
        }
    },
    distributeOptions: {
        distributePouchConfig: {
            source: "{that}.options.pouchConfig",
            target: "{that gpii.pouch.express}.options"
        }
    }
});

gpii.pouchManager.recreateExpressPouch = function (express) {
    console.log("in recreateExpressPouch");
    express.events.onCreateExpressPouch.fire();
};

fluid.defaults("gpii.pouchManager.resetMiddleware", {
    gradeNames: ["gpii.express.middleware"],
    path: "/reset-pouch",
    namespace: "resetMiddleware",
    invokers: {
        middleware: {
            funcName: "gpii.pouchManager.reset",
            args: ["{that}", "{arguments}.0", "{arguments}.1", "{arguments}.2"] // request, response, next
        }
    },
    events: {
        onReset: null
    },
    responses: {
        success: {
            statusCode: 200,
            message: "Success: Pouch has been reset to the initial state."
        },
        error: {
            statusCode: 500
        }
    }
});

gpii.pouchManager.reset = function (that, request, response) {
    var resetPromise = fluid.promise.fireTransformEvent(that.events.onReset);
    var responses = that.options.responses;
    resetPromise.then(function () {
        response.status(responses.success.statusCode).send(responses.success.message);
    }, function (err) {
        response.status(responses.error.statusCode).send(err);
    });
};
