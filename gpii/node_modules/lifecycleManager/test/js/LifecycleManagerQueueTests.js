/*!
GPII Lifecycle Manager Queue Tests

Copyright 2017 Raising The Floor - International

Licensed under the New BSD license. You may not use this file except in
compliance with this License.

You may obtain a copy of the License at
https://github.com/GPII/universal/blob/master/LICENSE.txt
*/

/* eslint-env browser */
/* eslint strict: ["error", "function"] */

/* global jqUnit, fluid */

(function () {
    "use strict";
    fluid.setLogging(true);

    var gpii = fluid.registerNamespace("gpii");

    fluid.registerNamespace("gpii.tests.lifecycleManager.queue");

    var promiseWrapFunc = function (timeout, func, reject) {
        return function (arg) {
            var myPromise = fluid.promise();
            setTimeout(function () {
                func(arg);
                reject ? myPromise.reject(arg) : myPromise.resolve(arg);
            }, timeout);
            return myPromise;
        };
    };

    var createCustomTask = function (timeout, func, arg) {
        return {
            func: promiseWrapFunc(timeout, func),
            args: arg,
            promise: fluid.promise()
        };
    };

    // ensure that we're processing queue in the correct order:
    jqUnit.asyncTest("Tasks are being processed on addition", function () {
        var lifecycleManager = gpii.lifecycleManager();
        jqUnit.expect(1);

        var queuePromise = lifecycleManager.addToQueue(createCustomTask(1, fluid.identity, 1));

        queuePromise.then(function (val) {
            jqUnit.assertEquals("Task was processed on addition to queue", 1, val);
            jqUnit.start();
        });
    });

    // ensure that we're processing queue in the correct order:
    jqUnit.asyncTest("Queue is being processed in the correct order", function () {
        var lifecycleManager = gpii.lifecycleManager();
        var results = [];
        var pushResultFunc = function (arg) {
            results.push(arg);
        };

        jqUnit.expect(1);

        lifecycleManager.addToQueue(createCustomTask(300, pushResultFunc, 1));
        lifecycleManager.addToQueue(createCustomTask(50, pushResultFunc, 2));
        var queuePromise3 = lifecycleManager.addToQueue(createCustomTask(100, pushResultFunc, 3));

        queuePromise3.then(function () {
            jqUnit.assertDeepEq("Task was processed on addition to queue", [1, 2, 3], results);
            jqUnit.start();
        });
    });

    jqUnit.asyncTest("Rejected promises causes the queue promise to be rejected", function () {
        var lifecycleManager = gpii.lifecycleManager();
        jqUnit.expect(1);

        var task = {
            func: promiseWrapFunc(200, fluid.identity, true),
            promise: fluid.promise()
        };
        var queuePromise = lifecycleManager.addToQueue(task);

        queuePromise.then(function () {
            jqUnit.fail("Rejected task should reject promise");
            jqUnit.start();
        }, function () {
            jqUnit.assertTrue("Task failed and promise was rejected", true);
            jqUnit.start();
        });
    });

    jqUnit.asyncTest("All promises in queue are rejected when a task fail", function () {
        var lifecycleManager = gpii.lifecycleManager();
        jqUnit.expect(4);

        var failTask = {
            func: promiseWrapFunc(200, fluid.identity, true),
            promise: fluid.promise()
        };
        // first task that succeeds
        lifecycleManager.addToQueue(createCustomTask(300, fluid.identity)).then(function () {
            jqUnit.assertTrue("First task should succeed", true);
        });
        // next task fails
        lifecycleManager.addToQueue(failTask).then(function () {
            jqUnit.fail("Second task should fail");
        }, function () {
            jqUnit.assertTrue("Second task failed as expected", true);
        });
        // subsequent tasks fail:
        lifecycleManager.addToQueue(createCustomTask(50, fluid.identity)).then(
            function () {},
            function () { jqUnit.assertTrue("third task failed as expected", true); }
        );
        lifecycleManager.addToQueue(createCustomTask(50, fluid.identity)).then(
            function () {},
            function () {
                jqUnit.assertTrue("fourth task failed as expected", true);
                jqUnit.start();
            }
        );
    });
})();
