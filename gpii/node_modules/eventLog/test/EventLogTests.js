/*
 * eventLog Tests
 *
 * Copyright 2017 Raising the Floor - International
 *
 * Licensed under the New BSD license. You may not use this file except in
 * compliance with this License.
 *
 * The R&D leading to these results received funding from the
 * Department of Education - Grant H421A150005 (GPII-APCP). However,
 * these results do not necessarily represent the policy of the
 * Department of Education, and you should not assume endorsement by the
 * Federal Government.
 *
 * You may obtain a copy of the License at
 * https://github.com/GPII/universal/blob/master/LICENSE.txt
 */

"use strict";

var fluid = require("infusion"),
    fs = require("fs"),
    os = require("os"),
    readline = require("readline");

var jqUnit = fluid.require("node-jqunit");
var gpii = fluid.registerNamespace("gpii");
fluid.registerNamespace("gpii.tests.eventLog");

require("../index.js");

var teardowns = [];

jqUnit.module("gpii.tests.eventLog", {
    teardown: function () {
        while (teardowns.length) {
            teardowns.pop()();
        }
    }
});

fluid.defaults("gpii.installID.test", {
    invokers: {
        getMachineID: "gpii.tests.eventLog.getMachineID"
    }
});

gpii.tests.eventLog.getMachineID = function () {
    return "TEST-MACHINE-ID";
};

/**
 * Creates a testable gpii.eventLog component.
 *
 * @param logFile {string} The log file
 * @return {Component} gpii.eventLog
 */
gpii.tests.eventLog.createEventLogComponent = function (logFile) {
    var eventLog = gpii.eventLog({
        gradeNames: "gpii.lifecycleManager",
        distributeOptions: {
            record: "gpii.installID.test",
            target: "{that installID}.options.gradeNames"
        },
        invokers: {
            createLinkId: gpii.tests.eventLog.createLinkId
        },
        members: {
            logFilePath: logFile,
            installationID: gpii.tests.eventLog.installID
        }
    });
    return eventLog;
};

gpii.tests.eventLog.installID = "installation-id";
gpii.tests.eventLog.timestamp = "2000-00-00T00:00:00.000Z";

/**
 * Returns a dummy id.
 * @return {String} A dummy id; "link-id".
 */
gpii.tests.eventLog.createLinkId = function () {
    return "link-id";
};

gpii.tests.eventLog.testDefs = fluid.freezeRecursive(fluid.transform([
    {
        // generated by the component
        testData: null,
        expected: {
            "level": "INFO",
            "module": "gpii",
            "event": "Start",
            "link": "link-id"
        }
    },
    {
        // data object
        testData: {
            func: "log",
            args: ["{that}", "module0", "event0", {"data0": "value0"}]
        },
        expected: {
            "level": "INFO",
            "module": "module0",
            "event": "event0",
            "data": {"data0": "value0"}
        }
    },
    {
        // no data
        testData: {
            func: "log",
            args: ["{that}", "module1", "event1"]
        },
        expected: {
            "level": "INFO",
            "module": "module1",
            "event": "event1"
        }
    },
    {
        // data string
        testData: {
            func: "log",
            args: ["{that}", "module2", "event2", "value2"]
        },
        expected: {
            "level": "INFO",
            "module": "module2",
            "event": "event2",
            "data": {"value": "value2"}
        }
    },
    {
        // data number
        testData: {
            func: "log",
            args: ["{that}", "module3", "event3", 1234]
        },
        expected: {
            "level": "INFO",
            "module": "module3",
            "event": "event3",
            "data": {"value": 1234}
        }
    },
    {
        // empty data
        testData: {
            func: "log",
            args: ["{that}", "module4", "event4", {}]
        },
        expected: {
            "level": "INFO",
            "module": "module4",
            "event": "event4"
        }
    },
    {
        // null data
        testData: {
            func: "log",
            args: ["{that}", "module5", "event5", null]
        },
        expected: {
            "level": "INFO",
            "module": "module5",
            "event": "event5"
        }
    },
    {
        // closeEvent
        testData: {
            func: "log",
            args: ["{that}", "module6", "event6", {}, "event6-close"]
        },
        expected: {
            "level": "INFO",
            "module": "module6",
            "event": "event6",
            "link": "link-id"
        } // event6-close logged at end
    },
    {
        // null data, closeEvent
        testData: {
            func: "log",
            args: ["{that}", "module7", "event7", null, "event7-close"]
        },
        expected: {
            "level": "INFO",
            "module": "module7",
            "event": "event7",
            "link": "link-id"
        }  // event7-close logged at end
    },
    {
        // closeEvent, log close
        testData: [{
            func: "log",
            args: ["{that}", "module8", "event8", null, "event8-close"]
        }, {
            func: "log",
            args: ["{that}", "module8", "event8-close"]
        }],
        expected: [{
            "level": "INFO",
            "module": "module8",
            "event": "event8",
            "link": "link-id"
        }, {
            "level": "INFO",
            "module": "module8",
            "event": "event8-close",
            "link": "link-id"
        }]
    },
    {
        // defer + logDeferred
        testData: [{
            func: "defer",
            args: ["{that}", "module9", "event9", null, "link-9"]
        }, {
            func: "logDeferred",
            args: ["{that}", "module9", "event9"]
        }],
        expected: {
            "level": "INFO",
            "module": "module9",
            "event": "event9",
            "link": "link-9"
        }
    },
    {
        // defer + logDeferred, with data
        testData: [{
            func: "defer",
            args: ["{that}", "module10", "event10", {"data10":"value10"}, "link-10"]
        }, {
            func: "logDeferred",
            args: ["{that}", "module10", "event10"]
        }],
        expected: {
            "level": "INFO",
            "module": "module10",
            "event": "event10",
            "data": {"data10":"value10"},
            "link": "link-10"
        }
    },
    {
        // defer + logDeferred, with new data
        testData: [{
            func: "defer",
            args: ["{that}", "module11", "event11", {"data11":"value11", "keep-data11":"keep-value11"}, "link-11"]
        }, {
            func: "logDeferred",
            args: ["{that}", "module11", "event11", {"data11":"changed-value11", "new-data11":"new-value11"}]
        }],
        expected: {
            "level": "INFO",
            "module": "module11",
            "event": "event11",
            "data": {"data11":"changed-value11", "new-data11":"new-value11", "keep-data11":"keep-value11"},
            "link": "link-11"
        }
    },
    {
        // defer + log
        testData: [{
            func: "defer",
            args: ["{that}", "module12", "event12"]
        }, {
            func: "log",
            args: ["{that}", "module12", "event12"]
        }],
        expected: {
            "level": "INFO",
            "module": "module12",
            "event": "event12"
        }
    },
    {
        // defer + logDeferred(null)
        testData: [{
            func: "defer",
            args: ["{that}", "module13a", "event13a"]
        }, {
            func: "defer",
            args: ["{that}", "module13b", "event13b"]
        }, {
            func: "logDeferred",
            args: ["{that}"]
        }],
        expected: [{
            "level": "INFO",
            "module": "module13b",
            "event": "event13b"
        }, {
            "level": "INFO",
            "module": "module13a",
            "event": "event13a"
        }, {
            // from test #7
            "level": "INFO",
            "module": "module7",
            "event": "event7-close",
            "link": "link-id"
        }, {
            // from test #6
            "level": "INFO",
            "module": "module6",
            "event": "event6-close",
            "link": "link-id"
        }, {
            // from component
            "level": "INFO",
            "module": "gpii",
            "event": "Stop",
            "link": "link-id"
        }]
    },
    {
        // test log level
        testData: {
            func: "log",
            args: ["{that}", "module14", "event14", {"data0": "value0"}, fluid.logLevel.WARN]
        },
        expected: {
            "level": "WARN",
            "module": "module14",
            "event": "event14",
            "data": {"data0": "value0"}
        }
    },
    {
        // logError
        testData: {
            func: "logError",
            args: ["{that}", "module15", "event15", {"error15": "value15"}]
        },
        expected: {
            "level": "FAIL",
            "module": "module15",
            "event": "Error.event15",
            "data": {
                "error": {"error15": "value15"}
            }
        }
    }
], function (item) {
    fluid.each(fluid.makeArray(item.expected), function (expected) {
        expected.timestamp = gpii.tests.eventLog.timestamp;
        expected.installID = gpii.tests.eventLog.installID;
    });
    return item;
}));

/**
 * Sets up the logging so it's predictable and can be examined easily.
 *
 * @return {string} The log file.
 */
gpii.tests.eventLog.prepareLogFile = function () {
    var logFile = os.tmpdir() + "/gpii-test-eventLog-" + Date.now();
    teardowns.push(function () {
        fs.unlinkSync(logFile);
    });

    //gpii.eventLog.setInstallId(gpii.tests.eventLog.installID);

    // Mock getTimestamp function
    var oldGetTimestamp = gpii.eventLog.getTimestamp;
    teardowns.push(function () {
        // Restore getTimestamp.
        gpii.eventLog.getTimestamp = oldGetTimestamp;
    });
    gpii.eventLog.getTimestamp = function () {
        return gpii.tests.eventLog.timestamp;
    };

    return logFile;
};

/**
 * Checks a log line.
 *
 * @param line {String} The log lone.
 * @param expected {Object} What it should parse into.
 */
gpii.tests.eventLog.checkLogLine = function (line, expected) {
    jqUnit.expect(3);
    jqUnit.assertTrue("Line should look like a JSON object", !!line.match(/^{.*}$/));
    var obj = JSON.parse(line);
    jqUnit.assertEquals("JSON should be an object", "object", typeof(obj));

    // data.duration is tricky to predict precisely, so just make sure it parses to a time within 5 seconds.
    if (obj.data && obj.data.hasOwnProperty("duration")) {
        jqUnit.expect(2);
        jqUnit.assertTrue("data.duration property should be >= 0", obj.data.duration >= 0);
        jqUnit.assertTrue("data.duration property shouldn't be more than 5 seconds", obj.data.duration < 5);
        obj.data.duration = 0;
    }

    jqUnit.assertDeepEq("Parsed log should match expected", expected, obj);
};

/**
 * Checks an entire log file.
 *
 * @param logFile {String} The log file
 * @param expected {Object[]} Array of objects expected for each line.
 * @return {Promise} A promise that resolves when the file is read.
 */
gpii.tests.eventLog.checkLogFile = function (logFile, expected) {
    var promise = fluid.promise();
    var reader = readline.createInterface({
        input: fs.createReadStream(logFile)
    });

    // Inspect each line of the log, making sure each one parses into the expected object.
    var lineNumber = 0;
    reader.on("line", function (line) {
        console.log("Log line", lineNumber, line);

        if (lineNumber >= expected.length) {
            jqUnit.fail("Log file should not contain more data.");
            promise.reject();
            reader.close();
            return;
        }
        gpii.tests.eventLog.checkLogLine(line, expected[lineNumber]);
        lineNumber++;
    });

    reader.on("close", function () {
        if (!promise.disposition) {
            promise.resolve();
        }
    });

    return promise;
};

jqUnit.asyncTest("Uncaught exception test", function () {
    jqUnit.expect(1);

    var logFile = gpii.tests.eventLog.prepareLogFile();
    gpii.tests.eventLog.createEventLogComponent(logFile);
    // Clear the log file
    fs.unlinkSync(logFile);

    // Unable to perform a "real" test of logging uncaught exceptions, so just check if the listener has been added.
    jqUnit.assert("Uncaught exception listener added", fluid.onUncaughtException.listeners.eventLog);

    var errorText = "eventLog failure logging test";
    var expected = [
        {
            "installID": gpii.tests.eventLog.installID,
            "timestamp": gpii.tests.eventLog.timestamp,
            "level": "FAIL",
            "module": "GPII",
            "event": "Error.Failure",
            "data": {"error": errorText}
        }
    ];

    // Test fluid.fail gets logged.
    jqUnit.expectFrameworkDiagnostic("testing fluid.fail gets logged", function () {
        fluid.fail(errorText);
    }, [errorText]);

    gpii.tests.eventLog.checkLogFile(logFile, expected)
        .then(jqUnit.start);
});

jqUnit.asyncTest("eventLog tests #1", function () {
    var tests = gpii.tests.eventLog.testDefs;
    var logFile = gpii.tests.eventLog.prepareLogFile();
    var expected = [];

    var that = gpii.tests.eventLog.createEventLogComponent(logFile);

    // Log the test data
    for (var n = 0; n < tests.length; n++) {
        var test = tests[n];
        var calls = fluid.makeArray(test.testData);
        while (calls.length) {
            var call = calls.shift();
            var args = fluid.transform(call.args, function (c) {
                return (c === "{that}") ? that : c;
            });
            gpii.eventLog[call.func].apply(null, args);
        }

        expected.push.apply(expected, fluid.makeArray(test.expected));
    }

    gpii.tests.eventLog.checkLogFile(logFile, expected)
        .then(jqUnit.start);
});
