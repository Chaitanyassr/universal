/* eslint-env node */
"use strict";
var fluid = require("infusion");
var gpii  = fluid.registerNamespace("gpii");

fluid.require("%kettle");
fluid.require("%gpii-json-schema");

// Add the ability to require JSON5 files.
require("json5/lib/register");

// Require universal so that we can resolve paths to it and any sub-modules.
require("../../../../../");

require("./filter-schema-settings");

fluid.registerNamespace("gpii.universal.solutionsRegistry.kettle.request.http");

/**
 *
 * An invoker called on component creation that filters the "mega schema" to only validate the settings observed in the
 * request.
 *
 * @param {Object} baseSchema - The original GSS schema to filter.
 * @param {Object} req - The request object from which we extract our observed settings.
 * @param {Object} rules - Model transformation rules to use to extract the observed settings from the request.
 * @return {Object} - The filtered GSS schema.
 */
gpii.universal.solutionsRegistry.kettle.request.http.generateFilteredSchema = function (baseSchema, req, rules) {
    // Find the location of the settings payload using the supplied transformation rules.
    var observedSettings = fluid.model.transformWithRules(req, rules);

    // Filter the underlying schema using the derived settings.
    var filteredSchema = gpii.universal.solutionsRegistry.filterSchemaToSettings(observedSettings, baseSchema);
    return filteredSchema;
};

/**
 *
 * A convenience function to resolve the path to our settings schema and "require" its contents.
 *
 * @param {String} settingsSchemaPath - A full or package-relative path to a GSS schema.
 * @return {Object} - The contents of the file found at `settingsSchemaPath`.
 *
 */
gpii.universal.solutionsRegistry.kettle.request.http.getSettingsSchema = function (settingsSchemaPath) {
    var resolvedPath = fluid.module.resolvePath(settingsSchemaPath);
    var schema = require(resolvedPath);
    return schema;
};

fluid.defaults("gpii.universal.solutionsRegistry.kettle.request.http.base", {
    gradeNames: ["gpii.schema.kettle.request.http"],
    mergePolicy: {
        // TODO: Discuss whether to move this up to gpii-json-schema and whether the "has query data" mix-in grade is worth preserving.
        "rules.requestContentToValidate": "nomerge",
        "rules.filterInput": "nomerge"
    },
    settingsSchemaPath: "%gpii-universal/build/schemas/settings-schema.json",
    settingsSchema: "@expand:gpii.universal.solutionsRegistry.kettle.request.http.getSettingsSchema({that}.options.settingsSchemaPath)",
    filteredSettingsSchema: "@expand:gpii.universal.solutionsRegistry.kettle.request.http.generateFilteredSchema({that}.options.settingsSchema, {request}.req, {that}.options.rules.filterInput)",
    rules: {
        filterInput: "{that}.options.rules.requestContentToValidate"
    },
    components: {
        validationMiddleware: {
            options: {
                inputSchema: "{gpii.universal.solutionsRegistry.kettle.request.http.base}.options.inputSchema"
            }
        }
    }
});

fluid.defaults("gpii.universal.solutionsRegistry.kettle.request.http.settings", {
    gradeNames: ["gpii.universal.solutionsRegistry.kettle.request.http.base"],
    rules: {
        filterInput: {
            "": "body.flat.contexts.gpii-default.preferences"
        }
    },
    inputSchema: {
        type: "object",
        properties: {
            flat: {
                type: "object",
                required: true,
                properties: {
                    contexts: {
                        type: "object",
                        required: true,
                        additionalProperties: {
                            type: "object",
                            required: true,
                            properties: {
                                settings: "{that}.options.filteredSettingsSchema"
                            }
                        }
                    }
                }
            }
        }
    }
});

fluid.defaults("gpii.universal.solutionsRegistry.kettle.request.http.preferences", {
    gradeNames: ["gpii.universal.solutionsRegistry.kettle.request.http.base"],
    rules: {
        filterInput: {
            "": {
                transform: {
                    type: "fluid.transforms.firstValue",
                    values: [
                        "body.contexts.gpii-default.preferences.application",
                        "body.contexts.gpii-default.preferences"
                    ]
                }
            }
        }
    },
    inputSchema: {
        type: "object",
        properties: {
            body: {
                type: "object",
                properties: {
                    contexts: {
                        type: "object",
                        required: true,
                        additionalProperties: {
                            type: "object",
                            required: true,
                            properties: {
                                metadata: {
                                    type: "array",
                                    item: {
                                        type: "object",
                                        properties: {
                                            scope: {
                                                type: "Array",
                                                items: {
                                                    type: "string",
                                                    format: "uri"
                                                }
                                            },
                                            source: {
                                                enum: ["snapshotter"],
                                                enumLabels: ["Snapshotter"]
                                            },
                                            type: {
                                                enum: ["provenance"],
                                                enumLabels: ["Provenance"]
                                            }
                                        }
                                    }
                                },
                                name: {
                                    type: "string"
                                },
                                preferences: {
                                    oneOf: [
                                        // Without a "view"
                                        "{that}.options.filteredSettingsSchema",
                                        // With a "view"
                                        {
                                            type: "object",
                                            properties: {
                                                application: "{that}.options.filteredSettingsSchema",
                                                // TODO: Break this down further.
                                                control: {
                                                    type: "object"
                                                }
                                            }
                                        }
                                    ]
                                }
                            }
                        }
                    }
                }
            }
        }
    }
});
